# 产品需求文档 (PRD)
## 企业级参考数据管理系统

**版本**: 1.0  
**日期**: 2025-08-04  
**产品经理**: 产品经理小王  

---

## 1. 产品概述

### 1.1 产品背景
企业需要一个专门用于管理各类参考数据的系统，包括客户信息、产品信息、配置参数等。系统需要支持CSV文件的标准化导入流程，确保数据质量和可追溯性。

### 1.2 产品定位
企业级CSV数据管理系统，专注于数据导入、验证、存储和可视化的完整流程管理。

### 1.3 目标用户
- **数据管理员**: 配置文件导入规则和验证逻辑
- **业务用户**: 查看数据和报表
- **系统管理员**: 管理用户权限和系统配置

---

## 2. 功能需求

### 2.1 CSV数据导入系统

#### 2.1.1 文件格式要求
- **文件命名规范**: `目录/文件名.yyyyMMddHHmmss.csv`
- **数据格式**: CSV格式，所有列均为string类型
- **示例**: `data/customer.20250104120000.csv`

#### 2.1.2 数据表映射
- 每个文件名对应一个数据表
- 表名规则: `文件名` + `时间戳`
- 示例: `customer.20250104120000.csv` → 表 `customer_20250104120000`

#### 2.1.3 版本控制
- 每个表包含序列号列，从1开始
- 每次导入文件，序列号自动+1
- 支持同一业务实体的多版本数据管理

### 2.2 两阶段数据加载机制

#### 2.2.1 Stage表(影子表)
- 每个业务表对应一个`_stage`后缀的影子表
- 数据首先导入Stage表进行预处理
- Stage表结构与目标表完全一致

#### 2.2.2 数据验证流程
- Stage表数据完成后，触发验证流程
- 支持两种验证方式:
  - **Stored Procedure**: 数据库存储过程
  - **Python Class**: Python验证类
- 验证通过的数据才能导入正式表

#### 2.2.3 验证结果记录
- 系统表记录每次验证的结果
- 包括验证状态、错误信息、处理时间等

### 2.3 系统配置管理

#### 2.3.1 配置表结构
| 字段名 | 类型 | 说明 |
|--------|------|------|
| csv_filename | string | 允许的CSV文件名模式 |
| validation_rule | string | 对应的验证规则 |
| target_table | string | 目标数据表名 |
| stage_table | string | 对应的Stage表名 |
| start_date | datetime | 配置生效开始日期 |
| end_date | datetime | 配置失效结束日期 |
| created_by | string | 添加配置的用户 |
| created_at | datetime | 配置创建时间 |

#### 2.3.2 配置管理功能
- 支持添加新的文件导入配置
- 支持修改现有配置
- 配置变更需要相应权限

### 2.4 用户权限管理

#### 2.4.1 用户表结构
| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | string | 用户唯一标识 |
| username | string | 用户名 |
| email | string | 邮箱地址 |
| user_group_id | string | 所属用户组ID |
| created_at | datetime | 创建时间 |
| is_active | boolean | 是否激活 |

#### 2.4.2 用户组表结构
| 字段名 | 类型 | 说明 |
|--------|------|------|
| group_id | string | 用户组唯一标识 |
| group_name | string | 用户组名称 |
| permissions | string | 权限配置(JSON格式) |
| created_at | datetime | 创建时间 |

#### 2.4.3 权限控制规则
- 任何允许的用户都可以添加新配置
- 只有同一用户组的用户可以更改配置
- 系统管理员拥有最高权限

### 2.5 日志系统

#### 2.5.1 系统日志表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| log_id | string | 日志唯一标识 |
| operation_type | string | 操作类型 |
| user_id | string | 操作用户 |
| timestamp | datetime | 操作时间 |
| details | string | 操作详情(JSON格式) |
| status | string | 操作状态 |

#### 2.5.2 验证结果日志表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| validation_id | string | 验证记录ID |
| csv_file | string | CSV文件名 |
| validation_rule | string | 使用的验证规则 |
| start_time | datetime | 验证开始时间 |
| end_time | datetime | 验证结束时间 |
| status | string | 验证状态(SUCCESS/FAILED) |
| error_count | int | 错误记录数 |
| total_count | int | 总记录数 |
| error_details | string | 错误详情(JSON格式) |

### 2.6 Web管理界面

#### 2.6.1 配置管理页面
- **新增配置**: 添加新的CSV文件导入配置
- **编辑配置**: 修改现有配置参数
- **配置列表**: 显示所有配置及其状态
- **配置详情**: 查看单个配置的详细信息

#### 2.6.2 用户管理页面
- **用户列表**: 显示所有用户及其所属组
- **用户编辑**: 修改用户信息和组归属
- **用户组管理**: 创建和编辑用户组

#### 2.6.3 文件上传页面
- **文件选择**: 支持CSV文件上传
- **导入预览**: 显示文件内容预览
- **导入执行**: 触发数据导入流程

### 2.7 Web报表和数据可视化

#### 2.7.1 日志浏览功能
- **操作日志**: 按时间、用户、操作类型筛选
- **验证日志**: 查看数据验证历史记录
- **错误分析**: 统计和分析常见错误

#### 2.7.2 数据导入可视化
- **导入统计图表**: 显示每日/每周/每月导入数据量
- **成功率趋势**: 数据验证成功率变化趋势
- **错误分布**: 各类错误的分布情况
- **性能监控**: 导入处理时间统计

---

## 3. 非功能性需求

### 3.1 技术架构约束
- **数据库**: 仅支持Microsoft SQL Server
- **部署方式**: 单节点部署，无负载均衡需求
- **数据类型**: CSV文件所有列均为string类型

### 3.2 性能要求
- 支持单文件最大100MB的CSV导入
- 验证处理时间不超过文件大小(MB) * 2秒
- Web界面响应时间不超过3秒

### 3.3 安全要求
- 用户身份认证
- 基于用户组的权限控制
- 操作审计日志记录
- 数据传输安全

### 3.4 可用性要求
- 系统可用性达到99%
- 支持7x24小时运行
- 友好的错误提示和处理

---

## 4. 用户故事

### 4.1 数据管理员用户故事

**故事1**: 配置新的CSV导入规则
- **作为** 数据管理员
- **我希望** 能够配置新的CSV文件导入规则
- **以便** 系统能够自动处理特定格式的数据文件

**验收标准**:
- 能够指定CSV文件名模式
- 能够配置对应的验证规则
- 能够设置目标表和Stage表
- 配置保存后立即生效

**故事2**: 设置数据验证逻辑
- **作为** 数据管理员  
- **我希望** 能够为不同的数据文件设置不同的验证逻辑
- **以便** 确保导入数据的质量和准确性

**验收标准**:
- 支持选择Stored Procedure或Python Class
- 验证逻辑配置简单直观
- 能够测试验证逻辑的正确性

### 4.2 业务用户用户故事

**故事3**: 查看数据导入历史
- **作为** 业务用户
- **我希望** 能够查看数据导入的历史记录
- **以便** 了解数据的来源和处理状态

**验收标准**:
- 显示导入时间、文件名、状态
- 支持按时间范围筛选
- 显示验证结果和错误信息

**故事4**: 查看数据统计报表
- **作为** 业务用户
- **我希望** 能够查看数据导入的统计报表
- **以便** 了解系统的整体运行情况

**验收标准**:
- 图表展示导入数据量趋势
- 显示成功率和错误率统计
- 支持不同时间维度的分析

### 4.3 系统管理员用户故事

**故事5**: 管理用户权限
- **作为** 系统管理员
- **我希望** 能够管理用户和用户组的权限
- **以便** 控制不同用户对系统功能的访问

**验收标准**:
- 能够创建和编辑用户组
- 能够分配用户到不同组
- 权限变更立即生效

---

## 5. 技术实现要点

### 5.1 数据库设计要点
- 所有业务表动态创建，结构相同
- Stage表与目标表结构保持一致
- 索引优化保证查询性能
- 事务处理保证数据一致性

### 5.2 验证机制设计
- 插件化验证架构，支持扩展
- 验证结果详细记录，便于调试
- 失败数据隔离处理，不影响成功数据

### 5.3 Web界面技术选型
- 前端: 现代Web技术栈(React/Vue等)
- 后端: Python Web框架(FastAPI/Django)
- 数据库连接: SQL Server驱动

---

## 6. 发布计划

### 6.1 MVP版本(v1.0)
**功能范围**:
- 基础CSV导入功能
- Stage表和验证机制
- 基础Web管理界面
- 简单的日志记录

**交付时间**: 6周

### 6.2 完整版本(v2.0)  
**功能范围**:
- 完整的用户权限管理
- 高级报表和数据可视化
- 系统监控和告警
- 性能优化

**交付时间**: 10周

---

## 7. 风险评估

### 7.1 技术风险
- **SQL Server兼容性**: 需要确保不同版本的兼容性
- **Python验证性能**: 大数据量时的处理性能
- **并发处理**: 多文件同时导入的处理能力

### 7.2 业务风险
- **数据质量**: 验证规则设计的合理性
- **用户接受度**: Web界面的易用性
- **数据安全**: 敏感数据的保护措施

### 7.3 风险缓解措施
- 充分的技术预研和性能测试
- 用户参与的界面原型验证
- 完善的数据备份和恢复机制

---

**文档状态**: 已完成  
**下一步**: 进入设计阶段，由设计师创建UI/UX设计方案