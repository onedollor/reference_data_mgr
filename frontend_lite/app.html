<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#54B848" />
    <meta name="description" content="Reference Data Auto Ingest System - Alpine.js + Tailwind Version" />
    <title>Reference Data Auto Ingest System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'td-green': '#54B848',
                        'td-green-light': '#7BC76F',
                        'td-green-dark': '#3A9B2F',
                        'td-dark-green': '#003F2D',
                        'td-dark-green-light': '#2C5F4A',
                        'td-dark-green-dark': '#002B1F',
                    },
                    fontFamily: {
                        'sans': ['Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    borderRadius: {
                        'xl': '12px',
                    },
                    boxShadow: {
                        'td': '0 2px 8px rgba(0,0,0,0.1)',
                        'td-card': '0 2px 12px rgba(0,0,0,0.08)',
                        'td-button': '0 2px 4px rgba(0,0,0,0.2)',
                        'td-button-hover': '0 4px 8px rgba(0,0,0,0.25)',
                    }
                }
            }
        }
    </script>
    
    <style>
        [x-cloak] { display: none !important; }
        
        .progress-line {
            display: block;
            margin: 2px 0;
        }
        
        .error-line {
            color: #d32f2f;
            font-weight: bold;
        }
        
        .progress-message {
            font-family: monospace;
            white-space: pre-wrap;
            margin: 8px 0;
        }
        
        /* Custom scrollbars */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Loading spinner animation */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Progress bar animation */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Fade in animation */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans antialiased min-h-screen" x-data="app()" x-init="init()">
    
    <!-- TD-Style Header -->
    <header class="bg-td-green border-b-4 border-td-dark-green text-white shadow-td">
        <div class="px-8 py-6">
            <h1 class="text-2xl font-bold tracking-wide mb-2">
                TD Reference Data Management
            </h1>
            <p class="text-white/90 text-sm">
                Automated CSV Data Ingestion System ***Limited For Reference Data Only***
            </p>
        </div>
    </header>

    <div class="max-w-6xl mx-auto py-8 px-6">
        
        <!-- System Status Card -->
        <div class="bg-white rounded-xl shadow-td-card border border-gray-200 mb-6">
            <div class="p-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">System Status</h2>
                
                <template x-if="systemStatus === 'loading'">
                    <div class="flex items-center mb-4">
                        <span class="material-icons text-td-green animate-spin mr-3 text-xl">sync</span>
                        <span class="text-sm text-gray-600">Checking system status...</span>
                    </div>
                </template>
                
                <template x-if="systemStatus === 'healthy'">
                    <div class="bg-td-green text-white px-4 py-3 rounded-lg flex items-center mb-4">
                        <span class="material-icons mr-2">check_circle</span>
                        <span class="font-medium">System is healthy and ready to process files</span>
                    </div>
                </template>
                
                <template x-if="systemStatus === 'error'">
                    <div class="bg-red-500 text-white px-4 py-3 rounded-lg flex items-center mb-4">
                        <span class="material-icons mr-2">error</span>
                        <span class="font-medium">System is not responding. Please check the backend service.</span>
                    </div>
                </template>

                <!-- System Configuration - Inside System Status Card -->
                <template x-if="systemStatus === 'healthy' && config">
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">System Configuration</h3>
                            <button 
                                @click="showConfigDetails = !showConfigDetails"
                                class="flex items-center px-3 py-1 border border-td-green text-td-green rounded-lg hover:bg-td-green hover:text-white transition-colors text-sm"
                            >
                                <span class="material-icons mr-1" x-text="showConfigDetails ? 'expand_less' : 'expand_more'"></span>
                                <span x-text="showConfigDetails ? 'Hide Details' : 'Show Details'"></span>
                            </button>
                        </div>

                        <!-- Basic Config Summary -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-td-green mb-2">File Limits</h4>
                                <p class="text-sm mb-1">
                                    <strong>Max Upload Size:</strong> <span x-text="formatFileSize(config.max_upload_size)"></span>
                                </p>
                                <p class="text-sm">
                                    <strong>Supported Formats:</strong> <span x-text="config.supported_formats?.join(', ') || 'CSV'"></span>
                                </p>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-td-green mb-2">Default CSV Format</h4>
                                <p class="text-sm mb-1">
                                    <strong>Column Delimiter:</strong> <code class="bg-gray-100 px-1 rounded" x-text="config.default_delimiters?.column_delimiter"></code>
                                </p>
                                <p class="text-sm mb-1">
                                    <strong>Text Qualifier:</strong> <code class="bg-gray-100 px-1 rounded" x-text="config.default_delimiters?.text_qualifier"></code>
                                </p>
                                <p class="text-sm">
                                    <strong>Row Delimiter:</strong> <code class="bg-gray-100 px-1 rounded" x-text="formatDelimiter(config.default_delimiters?.row_delimiter)"></code>
                                </p>
                            </div>
                        </div>

                        <!-- Detailed Configuration -->
                        <div x-show="showConfigDetails" x-transition class="border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold mb-4">Detailed Configuration</h4>
                            
                            <!-- Delimiter Options -->
                            <div class="mb-6">
                                <h5 class="font-medium mb-3">Available Delimiter Options</h5>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <div class="mb-4">
                                            <h6 class="text-sm font-medium mb-2">Header Delimiters</h6>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="option in config.delimiter_options?.header_delimiter || []">
                                                    <span class="inline-block bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs" x-text="formatDelimiter(option)"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <h6 class="text-sm font-medium mb-2">Column Delimiters</h6>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="option in config.delimiter_options?.column_delimiter || []">
                                                    <span class="inline-block bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs" x-text="formatDelimiter(option)"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="mb-4">
                                            <h6 class="text-sm font-medium mb-2">Row Delimiters</h6>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="option in config.delimiter_options?.row_delimiter || []">
                                                    <span class="inline-block bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs" x-text="formatDelimiter(option)"></span>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="mb-4">
                                            <h6 class="text-sm font-medium mb-2">Text Qualifiers</h6>
                                            <div class="flex flex-wrap gap-2">
                                                <template x-for="option in config.delimiter_options?.text_qualifier || []">
                                                    <span class="inline-block bg-gray-100 border border-gray-300 rounded px-2 py-1 text-xs" x-text="formatDelimiter(option)"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Information Table -->
                            <div>
                                <h5 class="font-medium mb-3">System Information</h5>
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left font-semibold">Setting</th>
                                                <th class="px-4 py-2 text-left font-semibold">Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Maximum Upload Size</td>
                                                <td class="px-4 py-2" x-text="formatFileSize(config.max_upload_size) + ' (' + config.max_upload_size.toLocaleString() + ' bytes)'"></td>
                                            </tr>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Supported File Formats</td>
                                                <td class="px-4 py-2" x-text="config.supported_formats?.join(', ') || 'CSV'"></td>
                                            </tr>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Default Header Delimiter</td>
                                                <td class="px-4 py-2"><code class="bg-gray-100 px-1 rounded" x-text="config.default_delimiters?.header_delimiter"></code></td>
                                            </tr>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Default Column Delimiter</td>
                                                <td class="px-4 py-2"><code class="bg-gray-100 px-1 rounded" x-text="config.default_delimiters?.column_delimiter"></code></td>
                                            </tr>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Default Row Delimiter</td>
                                                <td class="px-4 py-2"><code class="bg-gray-100 px-1 rounded" x-text="formatDelimiter(config.default_delimiters?.row_delimiter)"></code></td>
                                            </tr>
                                            <tr class="border-t border-gray-200">
                                                <td class="px-4 py-2">Default Text Qualifier</td>
                                                <td class="px-4 py-2"><code class="bg-gray-100 px-1 rounded" x-text="config.default_delimiters?.text_qualifier"></code></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center text-sm text-gray-600">
                                <span class="material-icons text-blue-500 mr-2">info</span>
                                <span>These settings define the system capabilities and default values for CSV processing. Custom values can be specified during file upload.</span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Main Content - Only show when system is healthy -->
        <template x-if="systemStatus === 'healthy' && config">
            <div>
                <!-- File Upload Section -->
                <div class="bg-white rounded-xl shadow-td-card border border-gray-200 mb-6">
                    <div class="p-6">
                        <h2 class="text-lg font-semibold text-gray-800 mb-4">File Upload & Configuration</h2>
                        
                        <!-- File Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select CSV File</label>
                            
                            <div>
                                <input 
                                    type="file" 
                                    accept=".csv" 
                                    @change="handleFileSelect($event)"
                                    :disabled="disabled"
                                    class="hidden" 
                                    id="file-upload"
                                />
                                <label 
                                    for="file-upload" 
                                    class="inline-flex items-center px-6 py-3 border-2 border-td-green text-td-green rounded-lg hover:bg-td-green hover:text-white transition-colors cursor-pointer font-semibold"
                                    :class="disabled ? 'opacity-50 cursor-not-allowed' : ''"
                                >
                                    <span class="material-icons mr-2">cloud_upload</span>
                                    Choose File
                                </label>
                            </div>
                            
                            <!-- File Info -->
                            <template x-if="selectedFile">
                                <div class="mt-3 p-3 bg-gray-50 rounded-lg text-sm">
                                    Selected: <span x-text="selectedFile.name"></span> (<span x-text="(selectedFile.size / 1024 / 1024).toFixed(2)"></span> MB)
                                </div>
                            </template>
                            
                            <!-- Upload Error -->
                            <template x-if="uploadError">
                                <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                    <span class="material-icons mr-2 text-red-500">error</span>
                                    <span x-text="uploadError"></span>
                                </div>
                            </template>
                        </div>

                        <!-- Auto-Detection Section -->
                        <template x-if="selectedFile">
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Format Detection</h3>
                                
                                <div class="flex flex-wrap items-center gap-4 mb-4">
                                    <button 
                                        @click="detectFormat"
                                        :disabled="disabled || autoDetection.isDetecting"
                                        class="inline-flex items-center px-4 py-2 rounded-lg font-medium transition-colors"
                                        :class="autoDetection.detected ? 'border border-gray-300 text-gray-700 hover:bg-gray-50' : 'bg-td-dark-green text-white hover:bg-td-dark-green-dark'"
                                    >
                                        <span class="material-icons mr-2" x-text="autoDetection.isDetecting ? 'sync' : 'search'" :class="autoDetection.isDetecting ? 'animate-spin' : ''"></span>
                                        <span x-text="autoDetection.isDetecting ? 'Detecting...' : (autoDetection.detected ? 'Re-Detect Format' : 'Auto-Detect Format')"></span>
                                    </button>
                                    
                                    <template x-if="autoDetection.detected">
                                        <span class="text-sm text-gray-600">(Auto-detected on file selection)</span>
                                    </template>
                                </div>

                                <!-- Detection Results -->
                                <template x-if="autoDetection.detected && autoDetection.suggestions">
                                    <div class="p-4 rounded-lg border mb-4" :class="getDetectionAlertClass(autoDetection.confidence)">
                                        <div class="font-medium text-sm mb-2">
                                            Format Detection Results (Confidence: <span x-text="(autoDetection.confidence * 100).toFixed(1)"></span>%)
                                        </div>
                                        <div class="text-sm space-y-1">
                                            <div>• Column Delimiter: "<span x-text="autoDetection.suggestions.column_delimiter"></span>"</div>
                                            <div>• Text Qualifier: "<span x-text="autoDetection.suggestions.text_qualifier"></span>"</div>
                                            <div>• Has Header: <span x-text="autoDetection.suggestions.has_header ? 'Yes' : 'No'"></span></div>
                                            <div>• Has Trailer: <span x-text="autoDetection.suggestions.has_trailer ? 'Yes' : 'No'"></span></div>
                                        </div>
                                        <template x-if="autoDetection.suggestions.trailer_line">
                                            <div class="mt-3 p-2 bg-gray-100 rounded font-mono text-sm">
                                                <strong>Trailer Line:</strong> "<span x-text="autoDetection.suggestions.trailer_line"></span>"
                                            </div>
                                        </template>
                                        <template x-if="autoDetection.analysis">
                                            <div class="mt-2 text-sm">
                                                Detected <span x-text="autoDetection.analysis.estimated_columns"></span> columns, 
                                                <span x-text="autoDetection.analysis.sample_rows"></span> sample rows, 
                                                encoding: <span x-text="autoDetection.analysis.encoding"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </template>

                        <!-- CSV Format Configuration -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">CSV Format Configuration</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <!-- Header Delimiter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Header Delimiter</label>
                                    <select 
                                        x-model="formatConfig.header_delimiter"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    >
                                        <template x-for="option in config.delimiter_options?.header_delimiter || []">
                                            <option :value="option" x-text="formatDelimiter(option)"></option>
                                        </template>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <!-- Column Delimiter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Column Delimiter</label>
                                    <select 
                                        x-model="formatConfig.column_delimiter"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    >
                                        <template x-for="option in config.delimiter_options?.column_delimiter || []">
                                            <option :value="option" x-text="formatDelimiter(option)"></option>
                                        </template>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <!-- Row Delimiter -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Row Delimiter</label>
                                    <select 
                                        x-model="formatConfig.row_delimiter"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    >
                                        <template x-for="option in config.delimiter_options?.row_delimiter || []">
                                            <option :value="option" x-text="formatDelimiter(option)"></option>
                                        </template>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <!-- Text Qualifier -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Text Qualifier</label>
                                    <select 
                                        x-model="formatConfig.text_qualifier"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    >
                                        <template x-for="option in config.delimiter_options?.text_qualifier || []">
                                            <option :value="option" x-text="formatDelimiter(option)"></option>
                                        </template>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                
                                <!-- Skip Lines -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Skip Lines After Header</label>
                                    <input 
                                        type="number" 
                                        x-model.number="formatConfig.skip_lines"
                                        min="0"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    />
                                </div>
                                
                                <!-- Trailer Line -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Trailer Line (Optional)</label>
                                    <input 
                                        type="text" 
                                        x-model="formatConfig.trailer_line"
                                        placeholder="e.g., TRAILER"
                                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-td-green focus:border-transparent"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Load Mode Selection -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-3">Data Load Mode</h3>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input 
                                        type="radio" 
                                        value="full" 
                                        x-model="formatConfig.load_mode"
                                        :disabled="disabled"
                                        class="mr-3 text-td-green focus:ring-td-green"
                                    />
                                    <span>Full Load (Replace all existing data)</span>
                                </label>
                                <label class="flex items-center">
                                    <input 
                                        type="radio" 
                                        value="append" 
                                        x-model="formatConfig.load_mode"
                                        :disabled="disabled"
                                        class="mr-3 text-td-green focus:ring-td-green"
                                    />
                                    <span>Append Load (Add to existing data)</span>
                                </label>
                            </div>
                        </div>

                        <!-- Upload Button -->
                        <button 
                            @click="handleUpload"
                            :disabled="!selectedFile || disabled || isUploading"
                            class="inline-flex items-center px-6 py-3 bg-td-green text-white rounded-lg hover:bg-td-green-dark transition-colors font-semibold shadow-td-button hover:shadow-td-button-hover disabled:opacity-50 disabled:cursor-not-allowed text-base"
                        >
                            <span class="material-icons mr-2" x-text="isUploading ? 'sync' : 'cloud_upload'" :class="isUploading ? 'animate-spin' : ''"></span>
                            <span x-text="isUploading ? 'Processing...' : 'Upload and Process'"></span>
                        </button>

                        <!-- Upload Progress -->
                        <template x-if="isUploading">
                            <div class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                    <div class="bg-td-green h-2 rounded-full progress-bar" :style="'width: ' + uploadProgress + '%'"></div>
                                </div>
                                <p class="text-sm text-gray-600">Uploading file and starting data ingestion...</p>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Progress Display -->
                <template x-if="uploadProgress !== null || ingestionData">
                    <div class="bg-white rounded-xl shadow-td-card border border-gray-200 mb-6">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-lg font-semibold text-gray-800">Processing Status</h2>
                                <div class="flex gap-2">
                                    <template x-if="ingestionData && !ingestionData.done && !ingestionData.canceled">
                                        <button 
                                            @click="cancelProcessing"
                                            :disabled="!progressKey"
                                            class="px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600 disabled:opacity-50"
                                        >
                                            Cancel
                                        </button>
                                    </template>
                                    <template x-if="ingestionData && (ingestionData.error || ingestionData.canceled)">
                                        <button 
                                            @click="resetProgress"
                                            class="px-3 py-1 text-sm bg-td-green text-white rounded hover:bg-td-green-dark"
                                        >
                                            Cancel Current Upload
                                        </button>
                                    </template>
                                    <template x-if="ingestionData && ingestionData.done && !ingestionData.error && !ingestionData.canceled">
                                        <button 
                                            @click="resetProgress"
                                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600"
                                        >
                                            Start New Upload
                                        </button>
                                    </template>
                                </div>
                            </div>

                            <!-- Upload Progress -->
                            <template x-if="uploadProgress !== null">
                                <div class="mb-6">
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Upload Progress</h3>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                        <div class="bg-td-green h-2 rounded-full progress-bar" :style="'width: ' + uploadProgress + '%'"></div>
                                    </div>
                                    <p class="text-sm text-gray-600"><span x-text="uploadProgress"></span>% complete</p>
                                </div>
                            </template>

                            <!-- Ingestion Progress -->
                            <template x-if="ingestionData">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-700 mb-2">Data Ingestion Progress</h3>
                                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                                        <div 
                                            class="h-2 rounded-full progress-bar"
                                            :class="ingestionData.error ? 'bg-red-500' : (ingestionData.done ? 'bg-green-500' : 'bg-td-green')"
                                            :style="'width: ' + (ingestionData.total ? ingestionData.percent : (ingestionData.done ? 100 : 30)) + '%'"
                                        ></div>
                                    </div>
                                    <div class="text-sm text-gray-700 mb-2">
                                        <span x-text="getIngestionStatusText(ingestionData)"></span>
                                    </div>
                                    <template x-if="ingestionData.total && ingestionData.inserted !== undefined">
                                        <div class="text-xs text-gray-500 mb-2">
                                            Rows: <span x-text="ingestionData.inserted.toLocaleString()"></span>/<span x-text="ingestionData.total.toLocaleString()"></span>
                                        </div>
                                    </template>
                                    <template x-if="ingestionData.error">
                                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                                            <p class="text-sm text-red-700">Ingestion failed. Check logs for details.</p>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>

                <!-- Reference Data Configuration Display -->
                <div class="bg-white rounded-xl shadow-td-card border border-gray-200 mb-6">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Reference Data Configuration</h2>
                            <button 
                                @click="loadReferenceDataConfig"
                                class="flex items-center px-3 py-1 text-sm text-td-green border border-td-green rounded hover:bg-td-green hover:text-white transition-colors"
                            >
                                <span class="material-icons mr-1 text-base">refresh</span>
                                Refresh
                            </button>
                        </div>

                        <template x-if="refDataLoading">
                            <div class="flex items-center justify-center py-8">
                                <span class="material-icons text-td-green animate-spin mr-3">sync</span>
                                <span class="text-sm text-gray-600">Loading Reference Data Configuration...</span>
                            </div>
                        </template>

                        <template x-if="refDataError">
                            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                                Failed to load Reference Data Configuration: <span x-text="refDataError"></span>
                            </div>
                        </template>

                        <template x-if="!refDataLoading && !refDataError">
                            <div>
                                <div class="flex justify-between items-center mb-4">
                                    <p class="text-sm text-gray-600">
                                        <span x-text="referenceData.length"></span> configuration<span x-text="referenceData.length !== 1 ? 's' : ''"></span> found
                                        <template x-if="refDataLastRefresh">
                                            <span class="ml-4 text-xs text-gray-400">
                                                Last updated: <span x-text="refDataLastRefresh.toLocaleTimeString()"></span>
                                            </span>
                                        </template>
                                    </p>
                                </div>

                                <template x-if="referenceData.length === 0">
                                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm">
                                        No Reference Data Configuration records found. Records are automatically created after successful data ingestion.
                                    </div>
                                </template>

                                <template x-if="referenceData.length > 0">
                                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                                        <table class="w-full text-sm">
                                            <thead class="bg-td-green text-white">
                                                <tr>
                                                    <th class="px-4 py-3 text-left font-semibold">Stored Procedure</th>
                                                    <th class="px-4 py-3 text-left font-semibold">Reference Name</th>
                                                    <th class="px-4 py-3 text-left font-semibold">Source Database</th>
                                                    <th class="px-4 py-3 text-left font-semibold">Schema</th>
                                                    <th class="px-4 py-3 text-left font-semibold">Table</th>
                                                    <th class="px-4 py-3 text-center font-semibold">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="(row, index) in referenceData" :key="row.ref_name || index">
                                                    <tr class="border-t border-gray-200 hover:bg-green-50" :class="index % 2 === 0 ? 'bg-gray-50' : 'bg-white'">
                                                        <td class="px-4 py-3 font-mono text-xs" x-text="row.sp_name"></td>
                                                        <td class="px-4 py-3 font-medium" x-text="row.ref_name"></td>
                                                        <td class="px-4 py-3" x-text="row.source_db"></td>
                                                        <td class="px-4 py-3 font-mono" x-text="row.source_schema"></td>
                                                        <td class="px-4 py-3 font-mono" x-text="row.source_table"></td>
                                                        <td class="px-4 py-3 text-center">
                                                            <span 
                                                                class="inline-block px-3 py-1 rounded-full text-xs font-medium min-w-[80px]"
                                                                :class="row.is_enabled === 1 ? 'bg-td-green text-white' : 'bg-gray-200 text-gray-700'"
                                                                x-text="row.is_enabled === 1 ? 'Enabled' : 'Disabled'"
                                                            ></span>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </template>

                                <template x-if="referenceData.length > 0">
                                    <p class="text-sm text-gray-600 mt-4">
                                        Showing <span x-text="referenceData.length"></span> configuration entries. Auto-refresh every 30 seconds.
                                        <template x-if="refDataLastRefresh">
                                            <span> Last updated: <span x-text="refDataLastRefresh.toLocaleTimeString()"></span>.</span>
                                        </template>
                                    </p>
                                </template>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- System Logs -->
                <div class="bg-white rounded-xl shadow-td-card border border-gray-200 mb-6">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">System Logs</h2>
                            <div class="flex gap-2">
                                <template x-if="logs.length > 10">
                                    <button 
                                        @click="expandedLogsList = !expandedLogsList"
                                        class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50"
                                        x-text="expandedLogsList ? 'Show 10' : 'Show 100'"
                                    ></button>
                                </template>
                                <button 
                                    @click="loadLogs"
                                    :disabled="logsLoading"
                                    class="flex items-center px-3 py-1 text-sm border border-td-green text-td-green rounded hover:bg-td-green hover:text-white transition-colors"
                                >
                                    <span class="material-icons mr-1 text-base" :class="logsLoading ? 'animate-spin' : ''">refresh</span>
                                    <span x-text="logsLoading ? 'Loading...' : 'Refresh'"></span>
                                </button>
                            </div>
                        </div>

                        <template x-if="logs.length > 0">
                            <p class="text-xs text-gray-600 mb-4">
                                <span x-text="expandedLogsList ? 'Showing last ' + Math.min(100, logs.length) + ' log entries' : 'Showing last ' + Math.min(100, logs.length) + ' log entries (displaying ' + Math.min(10, logs.length) + ' – click \'Show 100\' to expand)'"></span>
                            </p>
                        </template>

                        <template x-if="logsError">
                            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm" x-text="logsError"></div>
                        </template>

                        <template x-if="logs.length === 0 && !logsLoading">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm">
                                No logs available
                            </div>
                        </template>

                        <template x-if="logs.length > 0">
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="w-8 px-2 py-2"></th>
                                            <th class="px-4 py-2 text-left">Timestamp</th>
                                            <th class="px-4 py-2 text-left">Level</th>
                                            <th class="px-4 py-2 text-left">Action</th>
                                            <th class="px-4 py-2 text-left">Message</th>
                                        </tr>
                                    </thead>
                                    <tbody class="max-h-96 overflow-y-auto">
                                        <template x-for="(log, idx) in getDisplayLogs()" :key="idx">
                                            <tr class="border-t border-gray-200 hover:bg-gray-50">
                                                <td class="px-2 py-2">
                                                    <button 
                                                        @click="toggleLogExpansion(idx)"
                                                        class="p-1 hover:bg-gray-200 rounded"
                                                    >
                                                        <span class="material-icons text-sm" x-text="expandedLogRows.has(idx) ? 'expand_less' : 'expand_more'"></span>
                                                    </button>
                                                </td>
                                                <td class="px-4 py-2 font-mono text-xs">
                                                    <div x-text="formatTimestamp(log.timestamp_local)"></div>
                                                    <div class="text-gray-500" x-text="'UTC: ' + formatTimestamp(log.timestamp)"></div>
                                                </td>
                                                <td class="px-4 py-2">
                                                    <span 
                                                        class="inline-block px-2 py-1 rounded text-xs border"
                                                        :class="getLogLevelClass(log.level)"
                                                        x-text="log.level"
                                                    ></span>
                                                </td>
                                                <td class="px-4 py-2" x-text="log.action_step"></td>
                                                <td class="px-4 py-2" :class="log.level === 'ERROR' ? 'text-red-700 font-semibold' : ''" x-text="formatLogMessage(log.message)"></td>
                                            </tr>
                                        </template>
                                        <template x-for="(log, idx) in getDisplayLogs()" :key="'expanded-' + idx">
                                            <tr x-show="expandedLogRows.has(idx)" x-transition>
                                                <td colspan="5" class="px-0 py-0">
                                                    <div class="p-4 bg-gray-50 border-t border-gray-200">
                                                        <div class="mb-3">
                                                            <h4 class="text-sm font-medium mb-2">Full Message:</h4>
                                                            <div class="bg-white p-3 border border-gray-300 rounded font-mono text-xs whitespace-pre-wrap break-words" x-text="log.message"></div>
                                                        </div>
                                                        
                                                        <template x-if="log.traceback">
                                                            <div class="mb-3">
                                                                <h4 class="text-sm font-medium text-red-700 mb-2">Traceback:</h4>
                                                                <div class="bg-red-50 p-3 border border-red-300 rounded font-mono text-xs text-red-700 whitespace-pre-wrap break-words" x-text="log.traceback"></div>
                                                            </div>
                                                        </template>
                                                        
                                                        <template x-if="log.metadata && Object.keys(log.metadata).length > 0">
                                                            <div>
                                                                <h4 class="text-sm font-medium mb-2">Additional Information:</h4>
                                                                <div class="bg-white p-3 border border-gray-300 rounded">
                                                                    <template x-for="[key, value] in Object.entries(log.metadata)" :key="key">
                                                                        <template x-if="value">
                                                                            <div class="text-sm mb-1">
                                                                                <strong x-text="key + ':'"></strong> <span x-text="String(value)"></span>
                                                                            </div>
                                                                        </template>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </template>

                        <template x-if="logs.length > 0">
                            <p class="text-sm text-gray-600 mt-4">
                                Showing last <span x-text="logs.length"></span> log entries. Auto-refresh every 10 seconds.
                                <template x-if="logsLastUpdated">
                                    <span> Last updated: <span x-text="logsLastUpdated.toLocaleTimeString()"></span>.</span>
                                </template>
                            </p>
                        </template>
                    </div>
                </div>

                <!-- Rollback Manager -->
                <div class="bg-white rounded-xl shadow-td-card border border-gray-200">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-gray-800">Rollback Dataset Versions</h2>
                            <button 
                                @click="loadBackups"
                                :disabled="backupsLoading"
                                class="flex items-center px-3 py-1 text-sm border border-td-green text-td-green rounded hover:bg-td-green hover:text-white transition-colors"
                            >
                                <span class="material-icons mr-1 text-base" :class="backupsLoading ? 'animate-spin' : ''">refresh</span>
                                <span x-text="backupsLoading ? 'Loading...' : 'Refresh'"></span>
                            </button>
                        </div>

                        <template x-if="backupsError">
                            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm mb-4" x-text="backupsError"></div>
                        </template>

                        <template x-if="actionMsg">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm mb-4" x-text="actionMsg"></div>
                        </template>

                        <template x-if="backups.length === 0 && !backupsLoading && !backupsError">
                            <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-700 text-sm mb-4">
                                No backup tables found. Backup tables are created when data is uploaded and processed.
                            </div>
                        </template>

                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="w-8 px-2 py-2"></th>
                                        <th class="px-4 py-2 text-left">Backup Table</th>
                                        <th class="px-4 py-2 text-left">Main/Stage</th>
                                        <th class="px-4 py-2 text-left">Versions</th>
                                        <th class="px-4 py-2 text-left">Latest</th>
                                        <th class="px-4 py-2 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(backup, idx) in backups" :key="idx">
                                        <tr class="border-t border-gray-200 hover:bg-gray-50">
                                            <td class="px-2 py-2">
                                                <button 
                                                    @click="toggleBackupExpansion(idx)"
                                                    class="p-1 hover:bg-gray-200 rounded"
                                                >
                                                    <span class="material-icons text-sm" x-text="expandedBackupRows.has(idx) ? 'expand_less' : 'expand_more'"></span>
                                                </button>
                                            </td>
                                            <td class="px-4 py-2">
                                                <div class="font-mono text-xs" x-text="backup.backup_table"></div>
                                                <template x-if="!(backup.has_main && backup.has_stage)">
                                                    <div class="text-xs text-red-600">Missing related table(s)</div>
                                                </template>
                                            </td>
                                            <td class="px-4 py-2">
                                                <span 
                                                    class="inline-block px-2 py-1 rounded text-xs mr-1"
                                                    :class="backup.has_main ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                    x-text="backup.has_main ? 'Main OK' : 'Main MISSING'"
                                                ></span>
                                                <span 
                                                    class="inline-block px-2 py-1 rounded text-xs"
                                                    :class="backup.has_stage ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                                    x-text="backup.has_stage ? 'Stage OK' : 'Stage MISSING'"
                                                ></span>
                                            </td>
                                            <td class="px-4 py-2" x-text="backup.version_count"></td>
                                            <td class="px-4 py-2" x-text="backup.latest_version ?? '-'"></td>
                                            <td class="px-4 py-2">
                                                <div class="flex gap-2">
                                                    <template x-if="backup.latest_version && backup.has_main && backup.has_stage">
                                                        <button 
                                                            @click="viewBackupVersion(backup.base_name, backup.latest_version)"
                                                            class="px-2 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50"
                                                        >
                                                            View Latest
                                                        </button>
                                                    </template>
                                                    <template x-if="backup.has_main && backup.has_stage">
                                                        <button 
                                                            @click="exportBackupMain(backup.base_name)"
                                                            class="px-2 py-1 text-xs border border-td-dark-green text-td-dark-green rounded hover:bg-td-dark-green hover:text-white"
                                                        >
                                                            Export CSV
                                                        </button>
                                                    </template>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-for="(backup, idx) in backups" :key="'expanded-' + idx">
                                        <tr x-show="expandedBackupRows.has(idx)" x-transition>
                                            <td colspan="6" class="px-0 py-0">
                                                <div class="p-4 bg-gray-50 border-t border-gray-200">
                                                    <h4 class="text-sm font-medium mb-2">Versions for <span x-text="backup.backup_table"></span></h4>
                                                    <template x-if="backup.version_count === 0">
                                                        <p class="text-sm text-gray-600">No versions</p>
                                                    </template>
                                                    <template x-if="backup.version_count > 0">
                                                        <div class="flex flex-wrap gap-2">
                                                            <template x-for="v in Array.from({ length: backup.version_count }, (_, i) => backup.latest_version - i)" :key="v">
                                                                <button 
                                                                    @click="viewBackupVersion(backup.base_name, v)"
                                                                    class="px-3 py-1 text-xs rounded border cursor-pointer hover:bg-blue-50"
                                                                    :class="selectedVersion?.version_id === v && selectedVersion?.base_name === backup.base_name ? 'bg-blue-100 border-blue-300' : 'bg-white border-gray-300'"
                                                                    x-text="'v' + v"
                                                                ></button>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Load Type Warning Dialog -->
    <div 
        x-show="showLoadTypeDialog" 
        x-transition 
        class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50"
        x-cloak
    >
        <div class="bg-white rounded-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-yellow-50 border-b border-yellow-200 px-6 py-4 flex items-center">
                <span class="material-icons text-yellow-600 mr-3">warning</span>
                <h3 class="text-lg font-semibold text-yellow-800">Load Type Mismatch Detected</h3>
            </div>
            
            <div class="p-6">
                <template x-if="loadTypeVerification">
                    <div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <p class="font-medium text-yellow-800 mb-2">
                                The system has detected a load type mismatch for table "<span x-text="loadTypeVerification.table_name"></span>".
                            </p>
                            <p class="text-sm text-yellow-700" x-text="loadTypeVerification.explanation"></p>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Current Situation:</h4>
                            <div class="bg-gray-50 rounded-lg p-4 space-y-2 text-sm">
                                <div><strong>Requested Mode:</strong> <span x-text="loadTypeVerification.requested_load_mode"></span> load (would use load type '<span x-text="loadTypeVerification.requested_load_type"></span>')</div>
                                <div><strong>System Decision:</strong> Based on existing data, will use load type '<span x-text="loadTypeVerification.determined_load_type"></span>'</div>
                                <div><strong>Existing Load Types:</strong> <span x-text="loadTypeVerification.existing_load_types.length > 0 ? loadTypeVerification.existing_load_types.join(', ') : 'None'"></span></div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-6 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-3">Override Load Type:</h4>
                            <p class="text-sm text-gray-600 mb-4">
                                You can override the load type for this upload only. This will not change the existing data or future load type determination.
                            </p>

                            <div class="space-y-3">
                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer transition-colors" :class="overrideType === 'Full' ? 'border-td-green bg-green-50' : 'border-gray-200'">
                                    <input type="radio" value="Full" x-model="overrideType" class="mt-1 mr-3 text-td-green focus:ring-td-green" />
                                    <div>
                                        <div class="font-medium">Full Load</div>
                                        <div class="text-sm text-gray-600">Force all new rows to use load type 'F' regardless of existing data patterns</div>
                                    </div>
                                </label>
                                <label class="flex items-start p-4 border-2 rounded-lg cursor-pointer transition-colors" :class="overrideType === 'Append' ? 'border-td-green bg-green-50' : 'border-gray-200'">
                                    <input type="radio" value="Append" x-model="overrideType" class="mt-1 mr-3 text-td-green focus:ring-td-green" />
                                    <div>
                                        <div class="font-medium">Append Load</div>
                                        <div class="text-sm text-gray-600">Force all new rows to use load type 'A' regardless of existing data patterns</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <p class="text-sm text-blue-700">
                                <strong>Note:</strong> This override only affects the current upload. Future uploads will still follow the standard load type determination rules based on existing data.
                            </p>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="border-t border-gray-200 px-6 py-4 flex justify-end gap-3">
                <button 
                    @click="handleLoadTypeCancel"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                    Cancel Upload
                </button>
                <button 
                    @click="handleLoadTypeOverride"
                    :disabled="!overrideType"
                    class="px-4 py-2 bg-td-green text-white rounded-lg hover:bg-td-green-dark disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <span x-text="'Proceed with ' + overrideType + ' Load Type'"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Version Detail Dialog -->
    <div 
        x-show="selectedVersion" 
        x-transition 
        class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50"
        x-cloak
    >
        <div class="bg-white rounded-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold">
                    Version Details - <span x-text="selectedVersion?.base_name"></span> v<span x-text="selectedVersion?.version_id"></span>
                </h3>
            </div>
            
            <div class="p-6">
                <template x-if="selectedVersion">
                    <div>
                        <template x-if="getVersionData()">
                            <div>
                                <div class="flex flex-wrap items-center gap-4 mb-4 text-sm">
                                    <span>Total rows in version: <span x-text="getVersionData().total_rows"></span></span>
                                    <span>Showing <span x-text="getVersionData().rows.length"></span> fetched (limit <span x-text="getVersionData().fetchedLimit"></span>)</span>
                                    <button 
                                        @click="exportVersionData"
                                        class="px-3 py-1 border border-td-dark-green text-td-dark-green rounded hover:bg-td-dark-green hover:text-white"
                                    >
                                        Export This Version
                                    </button>
                                    <select 
                                        x-model="rowLimit"
                                        @change="loadVersion(selectedVersion.base_name, selectedVersion.version_id, rowLimit)"
                                        class="px-2 py-1 border border-gray-300 rounded text-sm"
                                    >
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                        <option value="500">500</option>
                                        <option value="750">750</option>
                                        <option value="1000">1000</option>
                                    </select>
                                    <button 
                                        @click="loadVersion(selectedVersion.base_name, selectedVersion.version_id, rowLimit)"
                                        class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-50"
                                    >
                                        Reload
                                    </button>
                                </div>
                                
                                <div class="border border-gray-200 rounded-lg overflow-auto max-h-96 custom-scrollbar">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50 sticky top-0">
                                            <tr>
                                                <template x-for="column in getVersionData().columns" :key="column">
                                                    <th class="px-4 py-2 text-left font-medium border-r border-gray-200 min-w-[140px]" x-text="column"></th>
                                                </template>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="(row, i) in getVersionData().rows" :key="i">
                                                <tr class="border-t border-gray-200 hover:bg-gray-50">
                                                    <template x-for="(cell, j) in row" :key="j">
                                                        <td class="px-4 py-2 border-r border-gray-200" x-text="cell === null ? '' : String(cell)"></td>
                                                    </template>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </template>
                        
                        <template x-if="!getVersionData()">
                            <div class="text-center py-8">
                                <span class="material-icons text-td-green animate-spin mr-2">sync</span>
                                <span>Loading...</span>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
            
            <div class="border-t border-gray-200 px-6 py-4 flex justify-between">
                <template x-if="selectedVersion">
                    <button 
                        @click="confirmRollback = selectedVersion"
                        class="flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                    >
                        <span class="material-icons mr-2">restore</span>
                        Rollback to v<span x-text="selectedVersion.version_id"></span>
                    </button>
                </template>
                <button 
                    @click="selectedVersion = null"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Rollback Confirmation Dialog -->
    <div 
        x-show="confirmRollback" 
        x-transition 
        class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50"
        x-cloak
    >
        <div class="bg-white rounded-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold">Confirm Rollback</h3>
            </div>
            
            <div class="p-6">
                <template x-if="confirmRollback">
                    <p class="text-sm">
                        Are you sure you want to rollback <strong x-text="confirmRollback.base_name"></strong> to version <strong x-text="confirmRollback.version_id"></strong>? This will replace current data.
                    </p>
                </template>
            </div>
            
            <div class="border-t border-gray-200 px-6 py-4 flex justify-end gap-3">
                <button 
                    @click="confirmRollback = null"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50"
                >
                    Cancel
                </button>
                <button 
                    @click="handleRollback"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600"
                >
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            const API_BASE_URL = 'http://localhost:8000';
            
            return {
                // System state
                systemStatus: 'loading',
                config: null,
                showConfigDetails: false,
                
                // File upload state
                selectedFile: null,
                uploadError: '',
                isUploading: false,
                uploadProgress: null,
                disabled: false,
                
                // Format configuration
                formatConfig: {
                    header_delimiter: '|',
                    column_delimiter: '|', 
                    row_delimiter: '|""\r\n',
                    text_qualifier: '"',
                    skip_lines: 0,
                    trailer_line: '',
                    load_mode: 'full'
                },
                
                // Auto-detection state
                autoDetection: {
                    isDetecting: false,
                    detected: false,
                    confidence: 0,
                    suggestions: null,
                    analysis: null
                },
                
                // Progress tracking
                ingestionData: null,
                progressKey: null,
                progressInterval: null,
                
                // Load type warning dialog
                showLoadTypeDialog: false,
                loadTypeVerification: null,
                overrideType: '',
                
                // Reference data config
                referenceData: [],
                refDataLoading: true,
                refDataError: null,
                refDataLastRefresh: null,
                
                // Logs
                logs: [],
                logsLoading: false,
                logsError: '',
                logsLastUpdated: null,
                expandedLogRows: new Set(),
                expandedLogsList: false,
                
                // Backups/Rollback
                backups: [],
                backupsLoading: false,
                backupsError: '',
                expandedBackupRows: new Set(),
                selectedVersion: null,
                versionRows: {},
                rowLimit: 100,
                confirmRollback: null,
                actionMsg: '',
                
                async init() {
                    await this.checkSystemHealth();
                    if (this.systemStatus === 'healthy') {
                        await this.loadConfiguration();
                    }
                    this.startLogPolling();
                    this.startReferenceDataPolling();
                    await this.loadBackups();
                },
                
                async checkSystemHealth() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/`);
                        if (response.ok) {
                            this.systemStatus = 'healthy';
                        } else {
                            this.systemStatus = 'error';
                        }
                    } catch (error) {
                        this.systemStatus = 'error';
                    }
                },
                
                async loadConfiguration() {
                    try {
                        const response = await fetch(`${API_BASE_URL}/config`);
                        if (response.ok) {
                            const configData = await response.json();
                            this.config = configData;
                            
                            // Set default delimiters
                            if (configData.default_delimiters) {
                                this.formatConfig = {
                                    ...this.formatConfig,
                                    ...configData.default_delimiters
                                };
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load configuration:', error);
                    }
                },
                
                formatFileSize(bytes) {
                    return (bytes / 1024 / 1024).toFixed(1) + ' MB';
                },
                
                formatDelimiter(option) {
                    if (!option) return '';
                    const map = {
                        '\r': '\\r',
                        '\n': '\\n', 
                        '\r\n': '\\r\\n',
                        '|""\r\n': '|""\\r\\n'
                    };
                    return map[option] || option;
                },
                
                async handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        if (file.size > this.config.max_upload_size) {
                            this.uploadError = `File size (${(file.size / 1024 / 1024).toFixed(2)} MB) exceeds maximum limit of ${(this.config.max_upload_size / 1024 / 1024).toFixed(2)} MB`;
                            this.selectedFile = null;
                        } else if (!file.name.toLowerCase().endsWith('.csv')) {
                            this.uploadError = 'Only CSV files are supported';
                            this.selectedFile = null;
                        } else {
                            this.selectedFile = file;
                            this.uploadError = '';
                            
                            // Reset auto-detection
                            this.autoDetection = {
                                isDetecting: false,
                                detected: false,
                                confidence: 0,
                                suggestions: null,
                                analysis: null
                            };
                            
                            // Auto-trigger format detection
                            setTimeout(() => this.detectFormat(), 100);
                        }
                    } else {
                        this.selectedFile = null;
                        this.uploadError = '';
                    }
                },
                
                async detectFormat() {
                    if (!this.selectedFile) return;
                    
                    this.autoDetection.isDetecting = true;
                    this.formatConfig.trailer_line = '';
                    
                    try {
                        const formData = new FormData();
                        formData.append('file', this.selectedFile);
                        
                        const response = await fetch(`${API_BASE_URL}/detect-format`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!response.ok) {
                            throw new Error('Format detection failed');
                        }
                        
                        const result = await response.json();
                        
                        this.autoDetection = {
                            isDetecting: false,
                            detected: true,
                            confidence: result.confidence,
                            suggestions: result.detected_format,
                            analysis: result.analysis
                        };
                        
                        // Apply detected settings
                        if (result.detected_format) {
                            this.formatConfig = {
                                ...this.formatConfig,
                                header_delimiter: result.detected_format.header_delimiter,
                                column_delimiter: result.detected_format.column_delimiter,
                                row_delimiter: result.detected_format.row_delimiter,
                                text_qualifier: result.detected_format.text_qualifier,
                                skip_lines: result.detected_format.skip_lines,
                                trailer_line: result.detected_format.trailer_line || ''
                            };
                        }
                        
                    } catch (error) {
                        console.error('Auto-detection failed:', error);
                        this.autoDetection = {
                            isDetecting: false,
                            detected: false,
                            confidence: 0,
                            suggestions: null,
                            analysis: null
                        };
                    }
                },
                
                getDetectionAlertClass(confidence) {
                    if (confidence > 0.7) return 'bg-green-50 border-green-200 text-green-800';
                    if (confidence > 0.4) return 'bg-yellow-50 border-yellow-200 text-yellow-800';
                    return 'bg-blue-50 border-blue-200 text-blue-800';
                },
                
                async verifyLoadType() {
                    if (!this.selectedFile) return null;
                    
                    try {
                        const formData = new FormData();
                        formData.append('filename', this.selectedFile.name);
                        formData.append('load_mode', this.formatConfig.load_mode);
                        
                        const response = await fetch(`${API_BASE_URL}/verify-load-type`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (response.ok) {
                            return await response.json();
                        }
                        return null;
                    } catch (error) {
                        console.warn('Load type verification error:', error);
                        return null;
                    }
                },
                
                async performUpload(overrideLoadType = null) {
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);
                    formData.append('header_delimiter', this.formatConfig.header_delimiter);
                    formData.append('column_delimiter', this.formatConfig.column_delimiter);
                    formData.append('row_delimiter', this.formatConfig.row_delimiter);
                    formData.append('text_qualifier', this.formatConfig.text_qualifier);
                    formData.append('skip_lines', this.formatConfig.skip_lines.toString());
                    formData.append('load_mode', this.formatConfig.load_mode);
                    
                    if (this.formatConfig.trailer_line) {
                        formData.append('trailer_line', this.formatConfig.trailer_line);
                    }
                    
                    if (overrideLoadType) {
                        formData.append('override_load_type', overrideLoadType);
                    }
                    
                    const response = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        this.uploadProgress = 100;
                        if (result.progress_key) {
                            this.progressKey = result.progress_key;
                            this.ingestionData = {
                                found: true,
                                stage: 'starting',
                                percent: 0,
                                inserted: 0,
                                total: null,
                                done: false,
                                error: null
                            };
                            this.startProgressPolling();
                        }
                    } else {
                        throw new Error(result.detail || 'Upload failed');
                    }
                },
                
                async handleUpload() {
                    if (!this.selectedFile) return;
                    
                    this.isUploading = true;
                    this.uploadError = '';
                    this.disabled = true;
                    this.uploadProgress = 0;
                    this.ingestionData = null;
                    this.progressKey = null;
                    
                    try {
                        // Verify load type
                        const verification = await this.verifyLoadType();
                        
                        if (verification && verification.has_mismatch) {
                            this.loadTypeVerification = verification;
                            this.showLoadTypeDialog = true;
                            this.isUploading = false;
                            this.disabled = false;
                            return;
                        }
                        
                        await this.performUpload();
                        
                    } catch (error) {
                        this.uploadError = `Upload failed: ${error.message}`;
                    } finally {
                        this.isUploading = false;
                        this.disabled = false;
                    }
                },
                
                handleLoadTypeOverride() {
                    if (!this.overrideType) return;
                    
                    this.showLoadTypeDialog = false;
                    this.isUploading = true;
                    this.disabled = true;
                    
                    this.performUpload(this.overrideType).catch(error => {
                        this.uploadError = `Upload failed: ${error.message}`;
                    }).finally(() => {
                        this.isUploading = false;
                        this.disabled = false;
                        this.loadTypeVerification = null;
                        this.overrideType = '';
                    });
                },
                
                handleLoadTypeCancel() {
                    this.showLoadTypeDialog = false;
                    this.loadTypeVerification = null;
                    this.overrideType = '';
                    this.isUploading = false;
                    this.disabled = false;
                },
                
                startProgressPolling() {
                    if (!this.progressKey) return;
                    
                    this.progressInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`${API_BASE_URL}/progress/${this.progressKey}`);
                            if (!response.ok) return;
                            
                            const data = await response.json();
                            if (data.found) {
                                this.ingestionData = data;
                                if (data.done || data.error) {
                                    this.stopProgressPolling();
                                    this.disabled = false;
                                    
                                    if (data.done && !data.error) {
                                        this.loadReferenceDataConfig();
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('Poll error:', error);
                        }
                    }, 2000);
                },
                
                stopProgressPolling() {
                    if (this.progressInterval) {
                        clearInterval(this.progressInterval);
                        this.progressInterval = null;
                    }
                },
                
                async cancelProcessing() {
                    if (!this.progressKey) return;
                    
                    // Update local state immediately
                    this.ingestionData = {
                        ...this.ingestionData,
                        canceled: true,
                        stage: 'canceling',
                        error: 'Cancellation requested'
                    };
                    
                    try {
                        await fetch(`${API_BASE_URL}/progress/${this.progressKey}/cancel`, {
                            method: 'POST'
                        });
                    } catch (error) {
                        console.log('Cancel request failed:', error);
                    }
                },
                
                resetProgress() {
                    this.uploadProgress = null;
                    this.ingestionData = null;
                    this.progressKey = null;
                    this.disabled = false;
                    this.stopProgressPolling();
                },
                
                getIngestionStatusText(data) {
                    if (data.canceled) return 'Canceled by user';
                    if (data.error) return `Error: ${data.error}`;
                    if (data.done) return 'Completed';
                    
                    let text = `Stage: ${data.stage}`;
                    if (data.stage === 'inserting' && data.total) {
                        text += ` • ${data.percent}% (${data.inserted?.toLocaleString()}/${data.total.toLocaleString()} rows)`;
                    } else if (data.total) {
                        text += ` • ${data.percent}%`;
                    }
                    return text;
                },
                
                // Reference Data Configuration
                async loadReferenceDataConfig() {
                    this.refDataLoading = true;
                    this.refDataError = null;
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/reference-data-config`);
                        if (!response.ok) {
                            throw new Error(`Failed to load Reference Data Config: ${response.status}`);
                        }
                        const result = await response.json();
                        this.referenceData = result.data || [];
                        this.refDataLastRefresh = new Date();
                    } catch (error) {
                        this.refDataError = error.message;
                    } finally {
                        this.refDataLoading = false;
                    }
                },
                
                // Logs
                async loadLogs() {
                    this.logsLoading = true;
                    this.logsError = '';
                    
                    try {
                        const ts = Date.now();
                        console.log('Loading logs from:', `${API_BASE_URL}/logs?ts=${ts}`);
                        
                        const response = await fetch(`${API_BASE_URL}/logs?ts=${ts}`);
                        
                        console.log('Logs response status:', response.status);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Logs loaded successfully:', result.logs?.length, 'entries');
                            console.log('First log entry:', result.logs?.[0]);
                            this.logs = result.logs || [];
                            this.logsLastUpdated = new Date();
                            console.log('this.logs after assignment:', this.logs.length, 'entries');
                        } else {
                            console.error('Logs response not ok:', response.status, response.statusText);
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('Error loading logs:', error);
                        this.logsError = error.message;
                    } finally {
                        this.logsLoading = false;
                    }
                },
                
                startLogPolling() {
                    this.loadLogs();
                    setInterval(() => this.loadLogs(), 10000);
                },

                startReferenceDataPolling() {
                    this.loadReferenceDataConfig();
                    setInterval(() => this.loadReferenceDataConfig(), 30000); // Refresh every 30 seconds
                },
                
                toggleLogExpansion(index) {
                    if (this.expandedLogRows.has(index)) {
                        this.expandedLogRows.delete(index);
                    } else {
                        this.expandedLogRows.add(index);
                    }
                },
                
                formatTimestamp(timestamp) {
                    if (!timestamp) return 'N/A';
                    try {
                        return new Date(timestamp).toLocaleString();
                    } catch {
                        return 'N/A';
                    }
                },
                
                getLogLevelClass(level) {
                    switch (level?.toUpperCase()) {
                        case 'ERROR':
                            return 'bg-red-100 text-red-800 border-red-200';
                        case 'WARNING':
                            return 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        case 'INFO':
                            return 'bg-blue-100 text-blue-800 border-blue-200';
                        default:
                            return 'bg-gray-100 text-gray-800 border-gray-200';
                    }
                },
                
                formatLogMessage(message) {
                    if (!message) return '';
                    if (message.length > 100) {
                        return message.substring(0, 100) + '...';
                    }
                    return message;
                },
                
                getDisplayLogs() {
                    const limit = this.expandedLogsList ? 100 : 10;
                    const displayLogs = this.logs.slice(-limit);
                    console.log('getDisplayLogs called:', 'total logs:', this.logs.length, 'limit:', limit, 'displaying:', displayLogs.length);
                    return displayLogs;
                },

                
                // Backups/Rollback
                async loadBackups() {
                    this.backupsLoading = true;
                    this.backupsError = '';
                    
                    try {
                        console.log('Loading backups from:', `${API_BASE_URL}/backups`);
                        const response = await fetch(`${API_BASE_URL}/backups`);
                        console.log('Backups response status:', response.status);
                        
                        if (!response.ok) throw new Error(`Failed to load backups: ${response.status}`);
                        const data = await response.json();
                        console.log('Backups data:', data);
                        this.backups = data.backups || [];
                        console.log('Backups after assignment:', this.backups.length, 'entries');
                    } catch (error) {
                        console.error('Error loading backups:', error);
                        this.backupsError = error.message;
                    } finally {
                        this.backupsLoading = false;
                    }
                },
                
                toggleBackupExpansion(index) {
                    if (this.expandedBackupRows.has(index)) {
                        this.expandedBackupRows.delete(index);
                    } else {
                        this.expandedBackupRows.add(index);
                    }
                },
                
                async viewBackupVersion(baseName, versionId) {
                    this.selectedVersion = { base_name: baseName, version_id: versionId };
                    await this.loadVersion(baseName, versionId, this.rowLimit);
                },
                
                async loadVersion(baseName, versionId, limit) {
                    const key = `${baseName}|${versionId}`;
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/backups/${baseName}/versions/${versionId}?limit=${limit}`);
                        if (!response.ok) throw new Error('Failed to load version rows');
                        const data = await response.json();
                        this.versionRows[key] = { ...data, fetchedLimit: limit };
                    } catch (error) {
                        this.versionRows[key] = { error: error.message, rows: [], columns: [] };
                    }
                },
                
                getVersionData() {
                    if (!this.selectedVersion) return null;
                    const key = `${this.selectedVersion.base_name}|${this.selectedVersion.version_id}`;
                    return this.versionRows[key];
                },
                
                async exportBackupMain(baseName) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/backups/${baseName}/export-main`, {
                            headers: { 'Accept': 'text/csv' }
                        });
                        
                        if (!response.ok) {
                            alert('Export failed: ' + response.status);
                            return;
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        
                        // Try to get filename from header
                        let filename = null;
                        const cd = response.headers.get('Content-Disposition');
                        if (cd) {
                            const match = cd.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/);
                            if (match) {
                                filename = decodeURIComponent(match[1] || match[2] || '').trim();
                            }
                        }
                        
                        if (!filename) {
                            const utcDate = new Date().toISOString().slice(0,10).replace(/-/g,'');
                            filename = `${baseName}.${utcDate}.csv`;
                        }
                        
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(() => window.URL.revokeObjectURL(url), 5000);
                    } catch (error) {
                        console.error('Export failed', error);
                    }
                },
                
                async exportVersionData() {
                    if (!this.selectedVersion) return;
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/backups/${this.selectedVersion.base_name}/versions/${this.selectedVersion.version_id}/export`, {
                            headers: { 'Accept': 'text/csv' }
                        });
                        
                        if (!response.ok) {
                            alert('Export failed: ' + response.status);
                            return;
                        }
                        
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        
                        let filename = null;
                        const cd = response.headers.get('Content-Disposition');
                        if (cd) {
                            const match = cd.match(/filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/);
                            if (match) filename = decodeURIComponent(match[1] || match[2] || '').trim();
                        }
                        
                        if (!filename) {
                            const utcDate = new Date().toISOString().slice(0,10).replace(/-/g,'');
                            filename = `${this.selectedVersion.base_name}.${utcDate}.csv`;
                        }
                        
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(() => window.URL.revokeObjectURL(url), 5000);
                    } catch (error) {
                        console.error('Version export failed', error);
                    }
                },
                
                async handleRollback() {
                    if (!this.confirmRollback) return;
                    
                    const { base_name, version_id } = this.confirmRollback;
                    this.actionMsg = '';
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/backups/${base_name}/rollback/${version_id}`, {
                            method: 'POST'
                        });
                        const data = await response.json();
                        
                        if (!response.ok) throw new Error(data.detail || 'Rollback failed');
                        
                        this.actionMsg = `Rollback success: main_rows=${data.main_rows} stage_rows=${data.stage_rows}`;
                        this.loadBackups();
                    } catch (error) {
                        this.actionMsg = `Rollback failed: ${error.message}`;
                    } finally {
                        this.confirmRollback = null;
                        this.selectedVersion = null;
                    }
                }
            }
        }
    </script>
</body>
</html>