using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data.SqlClient;
using System.Web.Http;
using System.Web.Http.Cors;
using ReferenceDataApi.Infrastructure;
using ReferenceDataApi.Models;

namespace ReferenceDataApi.Controllers
{
    [EnableCors(origins: "*", headers: "*", methods: "*")]
    public class ReferenceDataController : ApiController
    {
        private readonly IDatabaseManager _databaseManager;

        public ReferenceDataController()
        {
            _databaseManager = new DatabaseManager();
        }

        [HttpGet]
        [Route("")]
        [Route("api")]
        public ApiResponse<ApiInfo> GetApiInfo()
        {
            try
            {
                var info = new ApiInfo
                {
                    Title = "Reference Data Management API",
                    Version = "1.0.0",
                    Description = "ASP.NET Web API for Reference Data Management - .NET Framework 4.0 Compatible",
                    ServerTime = DateTime.Now
                };

                return ApiResponse<ApiInfo>.SuccessResult(info);
            }
            catch (Exception ex)
            {
                return ApiResponse<ApiInfo>.ErrorResult(ex.Message);
            }
        }

        [HttpGet]
        [Route("api/health/database")]
        public ApiResponse<DatabaseHealth> GetDatabaseHealth()
        {
            try
            {
                var connectionString = ConfigurationManager.ConnectionStrings["DefaultConnection"].ConnectionString;
                var health = new DatabaseHealth();

                using (var connection = new SqlConnection(connectionString))
                {
                    connection.Open();
                    health.IsConnected = true;
                    health.ServerVersion = connection.ServerVersion;
                    health.Database = connection.Database;
                    health.DataSource = connection.DataSource;
                }

                return ApiResponse<DatabaseHealth>.SuccessResult(health);
            }
            catch (Exception ex)
            {
                var health = new DatabaseHealth
                {
                    IsConnected = false
                };
                return ApiResponse<DatabaseHealth>.ErrorResult("Database connection failed: " + ex.Message);
            }
        }

        [HttpGet]
        [Route("api/config")]
        public ApiResponse<SystemConfiguration> GetConfiguration()
        {
            try
            {
                var config = new SystemConfiguration
                {
                    DataSchema = ConfigurationManager.AppSettings["DataSchema"] ?? "ref",
                    BackupSchema = ConfigurationManager.AppSettings["BackupSchema"] ?? "bkp",
                    PostloadStoredProcedure = ConfigurationManager.AppSettings["PostloadStoredProcedure"] ?? "sp_ref_postload",
                    Host = ConfigurationManager.AppSettings["Host"] ?? "localhost",
                    HttpPort = ConfigurationManager.AppSettings["HttpPort"] ?? "8000",
                    HttpsPort = ConfigurationManager.AppSettings["HttpsPort"] ?? "8001"
                };

                return ApiResponse<SystemConfiguration>.SuccessResult(config);
            }
            catch (Exception ex)
            {
                return ApiResponse<SystemConfiguration>.ErrorResult(ex.Message);
            }
        }

        [HttpGet]
        [Route("api/schemas")]
        public ApiResponse<List<string>> GetSchemas()
        {
            try
            {
                var schemas = _databaseManager.GetSchemas();
                return ApiResponse<List<string>>.SuccessResult(schemas);
            }
            catch (Exception ex)
            {
                return ApiResponse<List<string>>.ErrorResult(ex.Message);
            }
        }

        [HttpGet]
        [Route("api/schemas/{schemaName}/tables")]
        public ApiResponse<List<string>> GetTables(string schemaName)
        {
            try
            {
                var tables = _databaseManager.GetTables(schemaName);
                return ApiResponse<List<string>>.SuccessResult(tables);
            }
            catch (Exception ex)
            {
                return ApiResponse<List<string>>.ErrorResult(ex.Message);
            }
        }

        [HttpGet]
        [Route("api/schemas/{schemaName}/tables/{tableName}/columns")]
        public ApiResponse<Dictionary<string, string>> GetTableColumns(string schemaName, string tableName)
        {
            try
            {
                var columns = _databaseManager.GetTableColumns(schemaName, tableName);
                return ApiResponse<Dictionary<string, string>>.SuccessResult(columns);
            }
            catch (Exception ex)
            {
                return ApiResponse<Dictionary<string, string>>.ErrorResult(ex.Message);
            }
        }

        [HttpGet]
        [Route("api/test")]
        public ApiResponse<string> TestConnection()
        {
            try
            {
                var isConnected = _databaseManager.TestConnection();
                var message = isConnected ? "Database connection successful" : "Database connection failed";
                return ApiResponse<string>.SuccessResult(message);
            }
            catch (Exception ex)
            {
                return ApiResponse<string>.ErrorResult(ex.Message);
            }
        }
    }
}